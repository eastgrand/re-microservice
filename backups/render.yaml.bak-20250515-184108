services:
  # Main web service for the API endpoints
  - type: web
    name: nesto-mortgage-analytics
    env: python
    plan: starter
    buildCommand: >-
      echo "Starting build process with FORCED skip-training" && 
      chmod +x ./deploy_to_render.sh &&
      echo "This file indicates model training should be skipped during deployment" > .skip_training &&
      export SKIP_MODEL_TRAINING=true &&
      echo "âš¡ SKIP TRAINING ENABLED - Model training will be bypassed" &&
      ./deploy_to_render.sh
    startCommand: >-
      echo "Starting web service" &&
      python3 -c "import gc; gc.enable()" &&
      python3 -c "import sys; sys.path.append('.')" &&
      gunicorn --config=gunicorn_config.py app:app
    envVars:
      - key: SHAP_MAX_BATCH_SIZE
        value: "500"
      - key: REDIS_URL
        value: "rediss://default:AVnAAAIjcDEzZjMwMjdiYWI5MjA0NjY3YTQ4ZjRjZjZjNWZhNTdmM3AxMA@ruling-stud-22976.upstash.io:6379"
      - key: REDIS_HEALTH_CHECK_INTERVAL
        value: "30"
      - key: API_KEY
        sync: false  # This indicates that the value is secret and should be set in the Render dashboard
      - key: PORT
        value: "10000"
      
  # Worker service for processing SHAP jobs
  - type: worker
    name: nesto-mortgage-analytics-worker
    env: python
    buildCommand: >-
      echo "Building worker service" &&
      chmod +x ./deploy_to_render.sh &&
      export SKIP_MODEL_TRAINING=true &&
      ./deploy_to_render.sh &&
      pip install psutil python-dotenv
    startCommand: >-
      echo "Starting memory-optimized SHAP worker" &&
      python3 -c "import gc; gc.enable(); print('Garbage collection enabled')" &&
      python3 setup_worker.py
    plan: starter
    envVars:
      - key: SHAP_MAX_BATCH_SIZE
        value: "300"  # Smaller batch size for workers to avoid memory issues
      - key: REDIS_URL
        value: "rediss://default:AVnAAAIjcDEzZjMwMjdiYWI5MjA0NjY3YTQ4ZjRjZjZjNWZhNTdmM3AxMA@ruling-stud-22976.upstash.io:6379"
      - key: REDIS_HEALTH_CHECK_INTERVAL
        value: "30"
      - key: API_KEY
        sync: false  # This indicates that the value is secret and should be set in the Render dashboard